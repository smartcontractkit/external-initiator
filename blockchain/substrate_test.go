package blockchain

import (
	"bytes"
	"encoding/gob"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"reflect"
	"testing"

	"github.com/centrifuge/go-substrate-rpc-client/v2/types"
	"github.com/pkg/errors"
	"github.com/stretchr/testify/require"
)

var (
	substrateTestMetadataHex   = "6d6574610c281853797374656d011853797374656d401c4163636f756e7401010230543a3a4163636f756e744964944163636f756e74496e666f3c543a3a496e6465782c20543a3a4163636f756e74446174613e00210100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004e8205468652066756c6c206163636f756e7420696e666f726d6174696f6e20666f72206120706172746963756c6172206163636f756e742049442e3845787472696e736963436f756e7400000c753332040004b820546f74616c2065787472696e7369637320636f756e7420666f72207468652063757272656e7420626c6f636b2e2c426c6f636b576569676874010064776569676874733a3a45787472696e7369637357656967687440000000000000000000000000000000000488205468652063757272656e742077656967687420666f722074686520626c6f636b2e40416c6c45787472696e736963734c656e00000c753332040004410120546f74616c206c656e6774682028696e2062797465732920666f7220616c6c2065787472696e736963732070757420746f6765746865722c20666f72207468652063757272656e7420626c6f636b2e24426c6f636b4861736801010538543a3a426c6f636b4e756d6265721c543a3a48617368008000000000000000000000000000000000000000000000000000000000000000000498204d6170206f6620626c6f636b206e756d6265727320746f20626c6f636b206861736865732e3445787472696e736963446174610101050c7533321c5665633c75383e000400043d012045787472696e73696373206461746120666f72207468652063757272656e7420626c6f636b20286d61707320616e2065787472696e736963277320696e64657820746f206974732064617461292e184e756d626572010038543a3a426c6f636b4e756d6265721000000000040901205468652063757272656e7420626c6f636b206e756d626572206265696e672070726f6365737365642e205365742062792060657865637574655f626c6f636b602e28506172656e744861736801001c543a3a4861736880000000000000000000000000000000000000000000000000000000000000000004702048617368206f66207468652070726576696f757320626c6f636b2e3845787472696e73696373526f6f7401001c543a3a486173688000000000000000000000000000000000000000000000000000000000000000000415012045787472696e7369637320726f6f74206f66207468652063757272656e7420626c6f636b2c20616c736f2070617274206f662074686520626c6f636b206865616465722e1844696765737401002c4469676573744f663c543e040004f020446967657374206f66207468652063757272656e7420626c6f636b2c20616c736f2070617274206f662074686520626c6f636b206865616465722e184576656e747301008c5665633c4576656e745265636f72643c543a3a4576656e742c20543a3a486173683e3e040004a0204576656e7473206465706f736974656420666f72207468652063757272656e7420626c6f636b2e284576656e74436f756e740100284576656e74496e646578100000000004b820546865206e756d626572206f66206576656e747320696e2074686520604576656e74733c543e60206c6973742e2c4576656e74546f706963730101021c543a3a48617368845665633c28543a3a426c6f636b4e756d6265722c204576656e74496e646578293e000400282501204d617070696e67206265747765656e206120746f7069632028726570726573656e74656420627920543a3a486173682920616e64206120766563746f72206f6620696e646578657394206f66206576656e747320696e2074686520603c4576656e74733c543e3e60206c6973742e00510120416c6c20746f70696320766563746f727320686176652064657465726d696e69737469632073746f72616765206c6f636174696f6e7320646570656e64696e67206f6e2074686520746f7069632e2054686973450120616c6c6f7773206c696768742d636c69656e747320746f206c6576657261676520746865206368616e67657320747269652073746f7261676520747261636b696e67206d656368616e69736d20616e64e420696e2063617365206f66206368616e67657320666574636820746865206c697374206f66206576656e7473206f6620696e7465726573742e004d01205468652076616c756520686173207468652074797065206028543a3a426c6f636b4e756d6265722c204576656e74496e646578296020626563617573652069662077652075736564206f6e6c79206a7573744d012074686520604576656e74496e64657860207468656e20696e20636173652069662074686520746f70696320686173207468652073616d6520636f6e74656e7473206f6e20746865206e65787420626c6f636b0101206e6f206e6f74696669636174696f6e2077696c6c20626520747269676765726564207468757320746865206576656e74206d69676874206265206c6f73742e484c61737452756e74696d65557067726164650000584c61737452756e74696d6555706772616465496e666f04000455012053746f726573207468652060737065635f76657273696f6e6020616e642060737065635f6e616d6560206f66207768656e20746865206c6173742072756e74696d6520757067726164652068617070656e65642e545570677261646564546f553332526566436f756e74010010626f6f6c0400044d012054727565206966207765206861766520757067726164656420736f207468617420607479706520526566436f756e74602069732060753332602e2046616c7365202864656661756c7429206966206e6f742e38457865637574696f6e50686173650000145068617365040004882054686520657865637574696f6e207068617365206f662074686520626c6f636b2e01282866696c6c5f626c6f636b04185f726174696f1c50657262696c6c040901204120646973706174636820746861742077696c6c2066696c6c2074686520626c6f636b2077656967687420757020746f2074686520676976656e20726174696f2e1872656d61726b041c5f72656d61726b1c5665633c75383e1c6c204d616b6520736f6d65206f6e2d636861696e2072656d61726b2e002c2023203c7765696768743e24202d20604f28312960e0202d2042617365205765696768743a20302e36363520c2b5732c20696e646570656e64656e74206f662072656d61726b206c656e6774682e50202d204e6f204442206f7065726174696f6e732e302023203c2f7765696768743e387365745f686561705f7061676573041470616765730c75363420fc2053657420746865206e756d626572206f6620706167657320696e2074686520576562417373656d626c7920656e7669726f6e6d656e74277320686561702e002c2023203c7765696768743e24202d20604f283129604c202d20312073746f726167652077726974652e64202d2042617365205765696768743a20312e34303520c2b57360202d203120777269746520746f20484541505f5041474553302023203c2f7765696768743e207365745f636f64650410636f64651c5665633c75383e28682053657420746865206e65772072756e74696d6520636f64652e002c2023203c7765696768743e3501202d20604f2843202b2053296020776865726520604360206c656e677468206f662060636f64656020616e642060536020636f6d706c6578697479206f66206063616e5f7365745f636f64656088202d20312073746f726167652077726974652028636f64656320604f28432960292e7901202d20312063616c6c20746f206063616e5f7365745f636f6465603a20604f28532960202863616c6c73206073705f696f3a3a6d6973633a3a72756e74696d655f76657273696f6e6020776869636820697320657870656e73697665292e2c202d2031206576656e742e7d012054686520776569676874206f6620746869732066756e6374696f6e20697320646570656e64656e74206f6e207468652072756e74696d652c206275742067656e6572616c6c792074686973206973207665727920657870656e736976652e902057652077696c6c207472656174207468697320617320612066756c6c20626c6f636b2e302023203c2f7765696768743e5c7365745f636f64655f776974686f75745f636865636b730410636f64651c5665633c75383e201d012053657420746865206e65772072756e74696d6520636f646520776974686f757420646f696e6720616e7920636865636b73206f662074686520676976656e2060636f6465602e002c2023203c7765696768743e90202d20604f2843296020776865726520604360206c656e677468206f662060636f64656088202d20312073746f726167652077726974652028636f64656320604f28432960292e2c202d2031206576656e742e75012054686520776569676874206f6620746869732066756e6374696f6e20697320646570656e64656e74206f6e207468652072756e74696d652e2057652077696c6c207472656174207468697320617320612066756c6c20626c6f636b2e302023203c2f7765696768743e5c7365745f6368616e6765735f747269655f636f6e666967044c6368616e6765735f747269655f636f6e666967804f7074696f6e3c4368616e67657354726965436f6e66696775726174696f6e3e28a02053657420746865206e6577206368616e676573207472696520636f6e66696775726174696f6e2e002c2023203c7765696768743e24202d20604f28312960b0202d20312073746f72616765207772697465206f722064656c6574652028636f64656320604f28312960292ed8202d20312063616c6c20746f20606465706f7369745f6c6f67603a20557365732060617070656e6460204150492c20736f204f28312964202d2042617365205765696768743a20372e32313820c2b57334202d204442205765696768743aa820202020202d205772697465733a204368616e67657320547269652c2053797374656d20446967657374302023203c2f7765696768743e2c7365745f73746f7261676504146974656d73345665633c4b657956616c75653e206c2053657420736f6d65206974656d73206f662073746f726167652e002c2023203c7765696768743e94202d20604f2849296020776865726520604960206c656e677468206f6620606974656d73607c202d206049602073746f72616765207772697465732028604f28312960292e74202d2042617365205765696768743a20302e353638202a206920c2b57368202d205772697465733a204e756d626572206f66206974656d73302023203c2f7765696768743e306b696c6c5f73746f7261676504106b657973205665633c4b65793e2078204b696c6c20736f6d65206974656d732066726f6d2073746f726167652e002c2023203c7765696768743efc202d20604f28494b296020776865726520604960206c656e677468206f6620606b6579736020616e6420604b60206c656e677468206f66206f6e65206b657964202d206049602073746f726167652064656c6574696f6e732e70202d2042617365205765696768743a202e333738202a206920c2b57368202d205772697465733a204e756d626572206f66206974656d73302023203c2f7765696768743e2c6b696c6c5f70726566697808187072656669780c4b6579205f7375626b6579730c7533322c1501204b696c6c20616c6c2073746f72616765206974656d7320776974682061206b657920746861742073746172747320776974682074686520676976656e207072656669782e003d01202a2a4e4f54453a2a2a2057652072656c79206f6e2074686520526f6f74206f726967696e20746f2070726f7669646520757320746865206e756d626572206f66207375626b65797320756e64657241012074686520707265666978207765206172652072656d6f76696e6720746f2061636375726174656c792063616c63756c6174652074686520776569676874206f6620746869732066756e6374696f6e2e002c2023203c7765696768743edc202d20604f285029602077686572652060506020616d6f756e74206f66206b65797320776974682070726566697820607072656669786064202d206050602073746f726167652064656c6574696f6e732e74202d2042617365205765696768743a20302e383334202a205020c2b57380202d205772697465733a204e756d626572206f66207375626b657973202b2031302023203c2f7765696768743e1c7375696369646500286501204b696c6c207468652073656e64696e67206163636f756e742c20617373756d696e6720746865726520617265206e6f207265666572656e636573206f75747374616e64696e6720616e642074686520636f6d706f7369746590206461746120697320657175616c20746f206974732064656661756c742076616c75652e002c2023203c7765696768743e24202d20604f283129607c202d20312073746f72616765207265616420616e642064656c6574696f6e2e54202d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d5c2042617365205765696768743a20382e36323620c2b5731101204e6f2044422052656164206f72205772697465206f7065726174696f6e7320626563617573652063616c6c657220697320616c726561647920696e206f7665726c6179302023203c2f7765696768743e01144045787472696e7369635375636365737304304469737061746368496e666f04b820416e2065787472696e73696320636f6d706c65746564207375636365737366756c6c792e205c5b696e666f5c5d3c45787472696e7369634661696c6564083444697370617463684572726f72304469737061746368496e666f049420416e2065787472696e736963206661696c65642e205c5b6572726f722c20696e666f5c5d2c436f64655570646174656400045420603a636f6465602077617320757064617465642e284e65774163636f756e7404244163636f756e744964047c2041206e6577205c5b6163636f756e745c5d2077617320637265617465642e344b696c6c65644163636f756e7404244163636f756e744964046c20416e205c5b6163636f756e745c5d20776173207265617065642e1838426c6f636b48617368436f756e7438543a3a426c6f636b4e756d626572106009000004d820546865206d6178696d756d206e756d626572206f6620626c6f636b7320746f20616c6c6f7720696e206d6f7274616c20657261732e484d6178696d756d426c6f636b576569676874185765696768742000204aa9d1010000047c20546865206d6178696d756d20776569676874206f66206120626c6f636b2e2044625765696768743c52756e74696d6544625765696768744040787d010000000000e1f505000000000409012054686520776569676874206f662072756e74696d65206461746162617365206f7065726174696f6e73207468652072756e74696d652063616e20696e766f6b652e50426c6f636b457865637574696f6e576569676874185765696768742000f2052a0100000004510120546865206261736520776569676874206f6620657865637574696e67206120626c6f636b2c20696e646570656e64656e74206f6620746865207472616e73616374696f6e7320696e2074686520626c6f636b2e4c45787472696e736963426173655765696768741857656967687420405973070000000004790120546865206261736520776569676874206f6620616e2045787472696e73696320696e2074686520626c6f636b2c20696e646570656e64656e74206f6620746865206f662065787472696e736963206265696e672065786563757465642e484d6178696d756d426c6f636b4c656e6774680c753332100000500004a820546865206d6178696d756d206c656e677468206f66206120626c6f636b2028696e206279746573292e143c496e76616c6964537065634e616d6508150120546865206e616d65206f662073706563696669636174696f6e20646f6573206e6f74206d61746368206265747765656e207468652063757272656e742072756e74696d655420616e6420746865206e65772072756e74696d652e685370656356657273696f6e4e65656473546f496e637265617365084501205468652073706563696669636174696f6e2076657273696f6e206973206e6f7420616c6c6f77656420746f206465637265617365206265747765656e207468652063757272656e742072756e74696d655420616e6420746865206e65772072756e74696d652e744661696c6564546f4578747261637452756e74696d6556657273696f6e0cf0204661696c656420746f2065787472616374207468652072756e74696d652076657273696f6e2066726f6d20746865206e65772072756e74696d652e000d01204569746865722063616c6c696e672060436f72655f76657273696f6e60206f72206465636f64696e67206052756e74696d6556657273696f6e60206661696c65642e4c4e6f6e44656661756c74436f6d706f7369746504010120537569636964652063616c6c6564207768656e20746865206163636f756e7420686173206e6f6e2d64656661756c7420636f6d706f7369746520646174612e3c4e6f6e5a65726f526566436f756e740439012054686572652069732061206e6f6e2d7a65726f207265666572656e636520636f756e742070726576656e74696e6720746865206163636f756e742066726f6d206265696e67207075726765642e006052616e646f6d6e657373436f6c6c656374697665466c6970016052616e646f6d6e657373436f6c6c656374697665466c6970043852616e646f6d4d6174657269616c0100305665633c543a3a486173683e04000c610120536572696573206f6620626c6f636b20686561646572732066726f6d20746865206c61737420383120626c6f636b73207468617420616374732061732072616e646f6d2073656564206d6174657269616c2e2054686973610120697320617272616e67656420617320612072696e672062756666657220776974682060626c6f636b5f6e756d626572202520383160206265696e672074686520696e64657820696e746f20746865206056656360206f664420746865206f6c6465737420686173682e0100000000012454696d657374616d70012454696d657374616d70080c4e6f77010024543a3a4d6f6d656e7420000000000000000004902043757272656e742074696d6520666f72207468652063757272656e7420626c6f636b2e24446964557064617465010010626f6f6c040004b420446964207468652074696d657374616d7020676574207570646174656420696e207468697320626c6f636b3f01040c736574040c6e6f7748436f6d706163743c543a3a4d6f6d656e743e3c5820536574207468652063757272656e742074696d652e00590120546869732063616c6c2073686f756c6420626520696e766f6b65642065786163746c79206f6e63652070657220626c6f636b2e2049742077696c6c2070616e6963206174207468652066696e616c697a6174696f6ed82070686173652c20696620746869732063616c6c206861736e2774206265656e20696e766f6b656420627920746861742074696d652e004501205468652074696d657374616d702073686f756c642062652067726561746572207468616e207468652070726576696f7573206f6e652062792074686520616d6f756e74207370656369666965642062794420604d696e696d756d506572696f64602e00d820546865206469737061746368206f726967696e20666f7220746869732063616c6c206d7573742062652060496e686572656e74602e002c2023203c7765696768743ed0202d20604f285429602077686572652060546020636f6d706c6578697479206f6620606f6e5f74696d657374616d705f73657460a101202d20312073746f72616765207265616420616e6420312073746f72616765206d75746174696f6e2028636f64656320604f28312960292e202862656361757365206f6620604469645570646174653a3a74616b656020696e20606f6e5f66696e616c697a656029b4202d2031206576656e742068616e646c657220606f6e5f74696d657374616d705f7365746020604f285429602e302023203c2f7765696768743e0004344d696e696d756d506572696f6424543a3a4d6f6d656e7420b80b00000000000010690120546865206d696e696d756d20706572696f64206265747765656e20626c6f636b732e204265776172652074686174207468697320697320646966666572656e7420746f20746865202a65787065637465642a20706572696f64690120746861742074686520626c6f636b2070726f64756374696f6e206170706172617475732070726f76696465732e20596f75722063686f73656e20636f6e73656e7375732073797374656d2077696c6c2067656e6572616c6c79650120776f726b2077697468207468697320746f2064657465726d696e6520612073656e7369626c6520626c6f636b2074696d652e20652e672e20466f7220417572612c2069742077696c6c20626520646f75626c6520746869737020706572696f64206f6e2064656661756c742073657474696e67732e000210417572610000000000031c4772616e647061013c4772616e64706146696e616c6974791814537461746501006c53746f72656453746174653c543a3a426c6f636b4e756d6265723e04000490205374617465206f66207468652063757272656e7420617574686f72697479207365742e3450656e64696e674368616e676500008c53746f72656450656e64696e674368616e67653c543a3a426c6f636b4e756d6265723e040004c42050656e64696e67206368616e67653a20287369676e616c65642061742c207363686564756c6564206368616e6765292e284e657874466f72636564000038543a3a426c6f636b4e756d626572040004bc206e65787420626c6f636b206e756d6265722077686572652077652063616e20666f7263652061206368616e67652e1c5374616c6c656400008028543a3a426c6f636b4e756d6265722c20543a3a426c6f636b4e756d626572290400049020607472756560206966207765206172652063757272656e746c79207374616c6c65642e3043757272656e7453657449640100145365744964200000000000000000085d0120546865206e756d626572206f66206368616e6765732028626f746820696e207465726d73206f66206b65797320616e6420756e6465726c79696e672065636f6e6f6d696320726573706f6e736962696c697469657329c420696e20746865202273657422206f66204772616e6470612076616c696461746f72732066726f6d2067656e657369732e30536574496453657373696f6e0001051453657449643053657373696f6e496e6465780004001059012041206d617070696e672066726f6d206772616e6470612073657420494420746f2074686520696e646578206f6620746865202a6d6f737420726563656e742a2073657373696f6e20666f722077686963682069747368206d656d62657273207765726520726573706f6e7369626c652e00b82054574f582d4e4f54453a2060536574496460206973206e6f7420756e646572207573657220636f6e74726f6c2e010c4c7265706f72745f65717569766f636174696f6e084865717569766f636174696f6e5f70726f6f66a845717569766f636174696f6e50726f6f663c543a3a486173682c20543a3a426c6f636b4e756d6265723e3c6b65795f6f776e65725f70726f6f6640543a3a4b65794f776e657250726f6f66100d01205265706f727420766f7465722065717569766f636174696f6e2f6d69736265686176696f722e2054686973206d6574686f642077696c6c2076657269667920746865f82065717569766f636174696f6e2070726f6f6620616e642076616c69646174652074686520676976656e206b6579206f776e6572736869702070726f6f66fc20616761696e73742074686520657874726163746564206f6666656e6465722e20496620626f7468206172652076616c69642c20746865206f6666656e6365482077696c6c206265207265706f727465642e707265706f72745f65717569766f636174696f6e5f756e7369676e6564084865717569766f636174696f6e5f70726f6f66a845717569766f636174696f6e50726f6f663c543a3a486173682c20543a3a426c6f636b4e756d6265723e3c6b65795f6f776e65725f70726f6f6640543a3a4b65794f776e657250726f6f66240d01205265706f727420766f7465722065717569766f636174696f6e2f6d69736265686176696f722e2054686973206d6574686f642077696c6c2076657269667920746865f82065717569766f636174696f6e2070726f6f6620616e642076616c69646174652074686520676976656e206b6579206f776e6572736869702070726f6f66fc20616761696e73742074686520657874726163746564206f6666656e6465722e20496620626f7468206172652076616c69642c20746865206f6666656e6365482077696c6c206265207265706f727465642e00110120546869732065787472696e736963206d7573742062652063616c6c656420756e7369676e656420616e642069742069732065787065637465642074686174206f6e6c79190120626c6f636b20617574686f72732077696c6c2063616c6c206974202876616c69646174656420696e206056616c6964617465556e7369676e656460292c206173207375636819012069662074686520626c6f636b20617574686f7220697320646566696e65642069742077696c6c20626520646566696e6564206173207468652065717569766f636174696f6e28207265706f727465722e306e6f74655f7374616c6c6564081464656c617938543a3a426c6f636b4e756d6265726c626573745f66696e616c697a65645f626c6f636b5f6e756d62657238543a3a426c6f636b4e756d6265721c1d01204e6f74652074686174207468652063757272656e7420617574686f7269747920736574206f6620746865204752414e4450412066696e616c69747920676164676574206861732901207374616c6c65642e20546869732077696c6c2074726967676572206120666f7263656420617574686f7269747920736574206368616e67652061742074686520626567696e6e696e672101206f6620746865206e6578742073657373696f6e2c20746f20626520656e6163746564206064656c61796020626c6f636b7320616674657220746861742e205468652064656c617915012073686f756c64206265206869676820656e6f75676820746f20736166656c7920617373756d6520746861742074686520626c6f636b207369676e616c6c696e6720746865290120666f72636564206368616e67652077696c6c206e6f742062652072652d6f726765642028652e672e203130303020626c6f636b73292e20546865204752414e44504120766f7465727329012077696c6c20737461727420746865206e657720617574686f7269747920736574207573696e672074686520676976656e2066696e616c697a656420626c6f636b20617320626173652e5c204f6e6c792063616c6c61626c6520627920726f6f742e010c384e6577417574686f7269746965730434417574686f726974794c69737404d8204e657720617574686f726974792073657420686173206265656e206170706c6965642e205c5b617574686f726974795f7365745c5d1850617573656400049c2043757272656e7420617574686f726974792073657420686173206265656e207061757365642e1c526573756d65640004a02043757272656e7420617574686f726974792073657420686173206265656e20726573756d65642e001c2c50617573654661696c656408090120417474656d707420746f207369676e616c204752414e445041207061757365207768656e2074686520617574686f72697479207365742069736e2774206c697665a8202865697468657220706175736564206f7220616c72656164792070656e64696e67207061757365292e30526573756d654661696c656408150120417474656d707420746f207369676e616c204752414e44504120726573756d65207768656e2074686520617574686f72697479207365742069736e277420706175736564a42028656974686572206c697665206f7220616c72656164792070656e64696e6720726573756d65292e344368616e676550656e64696e6704ec20417474656d707420746f207369676e616c204752414e445041206368616e67652077697468206f6e6520616c72656164792070656e64696e672e1c546f6f536f6f6e04c02043616e6e6f74207369676e616c20666f72636564206368616e676520736f20736f6f6e206166746572206c6173742e60496e76616c69644b65794f776e65727368697050726f6f660435012041206b6579206f776e6572736869702070726f6f662070726f76696465642061732070617274206f6620616e2065717569766f636174696f6e207265706f727420697320696e76616c69642e60496e76616c696445717569766f636174696f6e50726f6f6604350120416e2065717569766f636174696f6e2070726f6f662070726f76696465642061732070617274206f6620616e2065717569766f636174696f6e207265706f727420697320696e76616c69642e584475706c69636174654f6666656e63655265706f7274041901204120676976656e2065717569766f636174696f6e207265706f72742069732076616c69642062757420616c72656164792070726576696f75736c79207265706f727465642e042042616c616e636573012042616c616e6365731034546f74616c49737375616e6365010028543a3a42616c616e6365400000000000000000000000000000000004982054686520746f74616c20756e6974732069737375656420696e207468652073797374656d2e1c4163636f756e7401010230543a3a4163636f756e7449645c4163636f756e74446174613c543a3a42616c616e63653e000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c6c205468652062616c616e6365206f6620616e206163636f756e742e004101204e4f54453a2054686973206973206f6e6c79207573656420696e20746865206361736520746861742074686973206d6f64756c65206973207573656420746f2073746f72652062616c616e6365732e144c6f636b7301010230543a3a4163636f756e744964705665633c42616c616e63654c6f636b3c543a3a42616c616e63653e3e00040008b820416e79206c6971756964697479206c6f636b73206f6e20736f6d65206163636f756e742062616c616e6365732e2501204e4f54453a2053686f756c64206f6e6c79206265206163636573736564207768656e2073657474696e672c206368616e67696e6720616e642066726565696e672061206c6f636b2e3853746f7261676556657273696f6e01002052656c656173657304000c7c2053746f726167652076657273696f6e206f66207468652070616c6c65742e00a020546869732069732073657420746f2076322e302e3020666f72206e6577206e6574776f726b732e0110207472616e736665720810646573748c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f757263651476616c75654c436f6d706163743c543a3a42616c616e63653e6cd8205472616e7366657220736f6d65206c697175696420667265652062616c616e636520746f20616e6f74686572206163636f756e742e00090120607472616e73666572602077696c6c207365742074686520604672656542616c616e636560206f66207468652073656e64657220616e642072656365697665722e21012049742077696c6c2064656372656173652074686520746f74616c2069737375616e6365206f66207468652073797374656d2062792074686520605472616e73666572466565602e1501204966207468652073656e6465722773206163636f756e742069732062656c6f7720746865206578697374656e7469616c206465706f736974206173206120726573756c74b4206f6620746865207472616e736665722c20746865206163636f756e742077696c6c206265207265617065642e00190120546865206469737061746368206f726967696e20666f7220746869732063616c6c206d75737420626520605369676e65646020627920746865207472616e736163746f722e002c2023203c7765696768743e3101202d20446570656e64656e74206f6e20617267756d656e747320627574206e6f7420637269746963616c2c20676976656e2070726f70657220696d706c656d656e746174696f6e7320666f72cc202020696e70757420636f6e6669672074797065732e205365652072656c617465642066756e6374696f6e732062656c6f772e6901202d20497420636f6e7461696e732061206c696d69746564206e756d626572206f6620726561647320616e642077726974657320696e7465726e616c6c7920616e64206e6f20636f6d706c657820636f6d7075746174696f6e2e004c2052656c617465642066756e6374696f6e733a0051012020202d2060656e737572655f63616e5f77697468647261776020697320616c776179732063616c6c656420696e7465726e616c6c792062757420686173206120626f756e64656420636f6d706c65786974792e2d012020202d205472616e7366657272696e672062616c616e63657320746f206163636f756e7473207468617420646964206e6f74206578697374206265666f72652077696c6c206361757365d420202020202060543a3a4f6e4e65774163636f756e743a3a6f6e5f6e65775f6163636f756e746020746f2062652063616c6c65642e61012020202d2052656d6f76696e6720656e6f7567682066756e64732066726f6d20616e206163636f756e742077696c6c20747269676765722060543a3a4475737452656d6f76616c3a3a6f6e5f756e62616c616e636564602e49012020202d20607472616e736665725f6b6565705f616c6976656020776f726b73207468652073616d652077617920617320607472616e73666572602c206275742068617320616e206164646974696f6e616cf82020202020636865636b207468617420746865207472616e736665722077696c6c206e6f74206b696c6c20746865206f726967696e206163636f756e742e88202d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d4501202d2042617365205765696768743a2037332e363420c2b5732c20776f7273742063617365207363656e6172696f20286163636f756e7420637265617465642c206163636f756e742072656d6f76656429dc202d204442205765696768743a2031205265616420616e64203120577269746520746f2064657374696e6174696f6e206163636f756e741501202d204f726967696e206163636f756e7420697320616c726561647920696e206d656d6f72792c20736f206e6f204442206f7065726174696f6e7320666f72207468656d2e302023203c2f7765696768743e2c7365745f62616c616e63650c0c77686f8c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f75726365206e65775f667265654c436f6d706163743c543a3a42616c616e63653e306e65775f72657365727665644c436f6d706163743c543a3a42616c616e63653e489420536574207468652062616c616e636573206f66206120676976656e206163636f756e742e00210120546869732077696c6c20616c74657220604672656542616c616e63656020616e642060526573657276656442616c616e63656020696e2073746f726167652e2069742077696c6c090120616c736f2064656372656173652074686520746f74616c2069737375616e6365206f66207468652073797374656d202860546f74616c49737375616e636560292e190120496620746865206e65772066726565206f722072657365727665642062616c616e63652069732062656c6f7720746865206578697374656e7469616c206465706f7369742c01012069742077696c6c20726573657420746865206163636f756e74206e6f6e63652028606672616d655f73797374656d3a3a4163636f756e744e6f6e636560292e00b420546865206469737061746368206f726967696e20666f7220746869732063616c6c2069732060726f6f74602e002c2023203c7765696768743e80202d20496e646570656e64656e74206f662074686520617267756d656e74732ec4202d20436f6e7461696e732061206c696d69746564206e756d626572206f6620726561647320616e64207772697465732e58202d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d3c202d2042617365205765696768743a6820202020202d204372656174696e673a2032372e353620c2b5736420202020202d204b696c6c696e673a2033352e313120c2b57398202d204442205765696768743a203120526561642c203120577269746520746f206077686f60302023203c2f7765696768743e38666f7263655f7472616e736665720c18736f757263658c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f7572636510646573748c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f757263651476616c75654c436f6d706163743c543a3a42616c616e63653e1851012045786163746c7920617320607472616e73666572602c2065786365707420746865206f726967696e206d75737420626520726f6f7420616e642074686520736f75726365206163636f756e74206d61792062652c207370656369666965642e2c2023203c7765696768743e4101202d2053616d65206173207472616e736665722c20627574206164646974696f6e616c207265616420616e6420777269746520626563617573652074686520736f75726365206163636f756e74206973902020206e6f7420617373756d656420746f20626520696e20746865206f7665726c61792e302023203c2f7765696768743e4c7472616e736665725f6b6565705f616c6976650810646573748c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f757263651476616c75654c436f6d706163743c543a3a42616c616e63653e2c51012053616d6520617320746865205b607472616e73666572605d2063616c6c2c206275742077697468206120636865636b207468617420746865207472616e736665722077696c6c206e6f74206b696c6c2074686540206f726967696e206163636f756e742e00bc20393925206f66207468652074696d6520796f752077616e74205b607472616e73666572605d20696e73746561642e00c4205b607472616e73666572605d3a207374727563742e4d6f64756c652e68746d6c236d6574686f642e7472616e736665722c2023203c7765696768743ee8202d2043686561706572207468616e207472616e736665722062656361757365206163636f756e742063616e6e6f74206265206b696c6c65642e60202d2042617365205765696768743a2035312e3420c2b5731d01202d204442205765696768743a2031205265616420616e64203120577269746520746f2064657374202873656e64657220697320696e206f7665726c617920616c7265616479292c20233c2f7765696768743e01201c456e646f77656408244163636f756e7449641c42616c616e636504250120416e206163636f756e74207761732063726561746564207769746820736f6d6520667265652062616c616e63652e205c5b6163636f756e742c20667265655f62616c616e63655c5d20447573744c6f737408244163636f756e7449641c42616c616e636508410120416e206163636f756e74207761732072656d6f7665642077686f73652062616c616e636520776173206e6f6e2d7a65726f206275742062656c6f77204578697374656e7469616c4465706f7369742cd020726573756c74696e6720696e20616e206f75747269676874206c6f73732e205c5b6163636f756e742c2062616c616e63655c5d205472616e736665720c244163636f756e744964244163636f756e7449641c42616c616e636504a0205472616e73666572207375636365656465642e205c5b66726f6d2c20746f2c2076616c75655c5d2842616c616e63655365740c244163636f756e7449641c42616c616e63651c42616c616e636504cc20412062616c616e6365207761732073657420627920726f6f742e205c5b77686f2c20667265652c2072657365727665645c5d1c4465706f73697408244163636f756e7449641c42616c616e636504210120536f6d6520616d6f756e7420776173206465706f73697465642028652e672e20666f72207472616e73616374696f6e2066656573292e205c5b77686f2c206465706f7369745c5d20526573657276656408244163636f756e7449641c42616c616e636504210120536f6d652062616c616e63652077617320726573657276656420286d6f7665642066726f6d206672656520746f207265736572766564292e205c5b77686f2c2076616c75655c5d28556e726573657276656408244163636f756e7449641c42616c616e636504290120536f6d652062616c616e63652077617320756e726573657276656420286d6f7665642066726f6d20726573657276656420746f2066726565292e205c5b77686f2c2076616c75655c5d4852657365727665526570617472696174656410244163636f756e744964244163636f756e7449641c42616c616e6365185374617475730c510120536f6d652062616c616e636520776173206d6f7665642066726f6d207468652072657365727665206f6620746865206669727374206163636f756e7420746f20746865207365636f6e64206163636f756e742edc2046696e616c20617267756d656e7420696e64696361746573207468652064657374696e6174696f6e2062616c616e636520747970652ea8205c5b66726f6d2c20746f2c2062616c616e63652c2064657374696e6174696f6e5f7374617475735c5d04484578697374656e7469616c4465706f73697428543a3a42616c616e636540f401000000000000000000000000000004d420546865206d696e696d756d20616d6f756e7420726571756972656420746f206b65657020616e206163636f756e74206f70656e2e203856657374696e6742616c616e6365049c2056657374696e672062616c616e636520746f6f206869676820746f2073656e642076616c7565544c69717569646974795265737472696374696f6e7304c8204163636f756e74206c6971756964697479207265737472696374696f6e732070726576656e74207769746864726177616c204f766572666c6f77047420476f7420616e206f766572666c6f7720616674657220616464696e674c496e73756666696369656e7442616c616e636504782042616c616e636520746f6f206c6f7720746f2073656e642076616c7565484578697374656e7469616c4465706f73697404ec2056616c756520746f6f206c6f7720746f20637265617465206163636f756e742064756520746f206578697374656e7469616c206465706f736974244b656570416c6976650490205472616e736665722f7061796d656e7420776f756c64206b696c6c206163636f756e745c4578697374696e6756657374696e675363686564756c6504cc20412076657374696e67207363686564756c6520616c72656164792065786973747320666f722074686973206163636f756e742c446561644163636f756e74048c2042656e6566696369617279206163636f756e74206d757374207072652d657869737405485472616e73616374696f6e5061796d656e7401485472616e73616374696f6e5061796d656e7408444e6578744665654d756c7469706c6965720100284d756c7469706c69657240000064a7b3b6e00d0000000000000000003853746f7261676556657273696f6e01002052656c6561736573040000000008485472616e73616374696f6e427974654665653042616c616e63654f663c543e4001000000000000000000000000000000040d01205468652066656520746f206265207061696420666f72206d616b696e672061207472616e73616374696f6e3b20746865207065722d6279746520706f7274696f6e2e2c576569676874546f466565a45665633c576569676874546f466565436f656666696369656e743c42616c616e63654f663c543e3e3e5c0401000000000000000000000000000000000000000001040d012054686520706f6c796e6f6d69616c2074686174206973206170706c69656420696e206f7264657220746f20646572697665206665652066726f6d207765696768742e0006105375646f01105375646f040c4b6579010030543a3a4163636f756e74496480000000000000000000000000000000000000000000000000000000000000000004842054686520604163636f756e74496460206f6620746865207375646f206b65792e0110107375646f041063616c6c5c426f783c3c542061732054726169743e3a3a43616c6c3e2839012041757468656e7469636174657320746865207375646f206b657920616e64206469737061746368657320612066756e6374696f6e2063616c6c20776974682060526f6f7460206f726967696e2e00d020546865206469737061746368206f726967696e20666f7220746869732063616c6c206d757374206265205f5369676e65645f2e002c2023203c7765696768743e20202d204f2831292e64202d204c696d697465642073746f726167652072656164732e60202d204f6e6520444220777269746520286576656e74292ec8202d20576569676874206f662064657269766174697665206063616c6c6020657865637574696f6e202b2031302c3030302e302023203c2f7765696768743e547375646f5f756e636865636b65645f776569676874081063616c6c5c426f783c3c542061732054726169743e3a3a43616c6c3e1c5f776569676874185765696768742839012041757468656e7469636174657320746865207375646f206b657920616e64206469737061746368657320612066756e6374696f6e2063616c6c20776974682060526f6f7460206f726967696e2e310120546869732066756e6374696f6e20646f6573206e6f7420636865636b2074686520776569676874206f66207468652063616c6c2c20616e6420696e737465616420616c6c6f777320746865b4205375646f207573657220746f20737065636966792074686520776569676874206f66207468652063616c6c2e00d020546865206469737061746368206f726967696e20666f7220746869732063616c6c206d757374206265205f5369676e65645f2e002c2023203c7765696768743e20202d204f2831292ed0202d2054686520776569676874206f6620746869732063616c6c20697320646566696e6564206279207468652063616c6c65722e302023203c2f7765696768743e1c7365745f6b6579040c6e65778c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f757263652475012041757468656e74696361746573207468652063757272656e74207375646f206b657920616e6420736574732074686520676976656e204163636f756e7449642028606e6577602920617320746865206e6577207375646f206b65792e00d020546865206469737061746368206f726967696e20666f7220746869732063616c6c206d757374206265205f5369676e65645f2e002c2023203c7765696768743e20202d204f2831292e64202d204c696d697465642073746f726167652072656164732e44202d204f6e65204442206368616e67652e302023203c2f7765696768743e1c7375646f5f6173080c77686f8c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f757263651063616c6c5c426f783c3c542061732054726169743e3a3a43616c6c3e2c51012041757468656e7469636174657320746865207375646f206b657920616e64206469737061746368657320612066756e6374696f6e2063616c6c207769746820605369676e656460206f726967696e2066726f6d44206120676976656e206163636f756e742e00d020546865206469737061746368206f726967696e20666f7220746869732063616c6c206d757374206265205f5369676e65645f2e002c2023203c7765696768743e20202d204f2831292e64202d204c696d697465642073746f726167652072656164732e60202d204f6e6520444220777269746520286576656e74292ec8202d20576569676874206f662064657269766174697665206063616c6c6020657865637574696f6e202b2031302c3030302e302023203c2f7765696768743e010c14537564696404384469737061746368526573756c74048c2041207375646f206a75737420746f6f6b20706c6163652e205c5b726573756c745c5d284b65794368616e67656404244163636f756e74496404010120546865205c5b7375646f65725c5d206a757374207377697463686564206964656e746974793b20746865206f6c64206b657920697320737570706c6965642e285375646f4173446f6e650410626f6f6c048c2041207375646f206a75737420746f6f6b20706c6163652e205c5b726573756c745c5d00042c526571756972655375646f04802053656e646572206d75737420626520746865205375646f206163636f756e740734436861696e6c696e6b466565640134436861696e6c696e6b466565642c2c50616c6c657441646d696e010030543a3a4163636f756e74496480000000000000000000000000000000000000000000000000000000000000000004cc20546865206163636f756e7420636f6e74726f6c6c696e67207468652066756e647320666f7220746869732070616c6c65742e4850656e64696e6750616c6c657441646d696e000030543a3a4163636f756e744964040004ac20546865206163636f756e7420746f20736574206173206675747572652070616c6c65742061646d696e2e104465627401003042616c616e63654f663c543e400000000000000000000000000000000004150120547261636b732074686520616d6f756e74206f6620646562742061636372756564206279207468652070616c6c657420746f776172647320746865206f7261636c65732e2c46656564436f756e746572010024543a3a466565644964100000000004050120412072756e6e696e6720636f756e746572207573656420696e7465726e616c6c7920746f2064657465726d696e6520746865206e65787420666565642069642e14466565647300010524543a3a4665656449643c46656564436f6e6669674f663c543e000400046820436f6e66696775726174696f6e20666f72206120666565642e304665656443726561746f727300010230543a3a4163636f756e7449640828290004000488204163636f756e747320616c6c6f77656420746f206372656174652066656564732e18526f756e647300020524543a3a46656564496428543a3a526f756e64496428526f756e644f663c543e050400046020557365722d666163696e6720726f756e6420646174612e1c44657461696c7300020524543a3a46656564496428543a3a526f756e64496444526f756e6444657461696c734f663c543e0504000470204f70657261746f722d666163696e6720726f756e6420646174612e1c4f7261636c657300010230543a3a4163636f756e7449643c4f7261636c654d6574614f663c543e00040004010120476c6f62616c206f7261636c65206d657461206461746120696e636c7564696e672061646d696e20616e6420776974686472617761626c652066756e64732e2c4f7261636c65537461746900020524543a3a46656564496430543a3a4163636f756e744964444f7261636c655374617475734f663c543e020400047c2046656564206c6f63616c206f7261636c652073746174757320646174612e285265717565737465727300020524543a3a46656564496430543a3a4163636f756e744964385265717565737465724f663c543e02040004c0205065722d66656564207065726d697373696f6e696e6720666f72207374617274696e67206e657720726f756e64732e014c2c6372656174655f66656564201c7061796d656e743042616c616e63654f663c543e1c74696d656f757438543a3a426c6f636b4e756d6265725c7375626d697373696f6e5f76616c75655f626f756e64735028543a3a56616c75652c20543a3a56616c7565293c6d696e5f7375626d697373696f6e730c75333220646563696d616c730875382c6465736372697074696f6e1c5665633c75383e34726573746172745f64656c617928543a3a526f756e6449641c6f7261636c6573845665633c28543a3a4163636f756e7449642c20543a3a4163636f756e744964293e08dc204372656174652061206e6577206f7261636c65206665656420776974682074686520676976656e20636f6e6669672076616c7565732e88204c696d6974656420746f20666565642063726561746f72206163636f756e74732e487472616e736665725f6f776e657273686970081c666565645f696424543a3a466565644964246e65775f6f776e657230543a3a4163636f756e74496404c820496e69746961746520746865207472616e73666572206f6620746865206665656420746f20606e65775f6f776e6572602e406163636570745f6f776e657273686970041c666565645f696424543a3a466565644964049c2041636365707420746865207472616e73666572206f662066656564206f776e6572736869702e187375626d69740c1c666565645f696424543a3a46656564496420726f756e645f696428543a3a526f756e644964287375626d697373696f6e20543a3a56616c756508c0205375626d69742061206e65772076616c756520746f2074686520676976656e206665656420616e6420726f756e642e88204c696d6974656420746f20746865206f7261636c6573206f66206120666565642e386368616e67655f6f7261636c65730c1c666565645f696424543a3a46656564496428746f5f64697361626c65445665633c543a3a4163636f756e7449643e18746f5f616464845665633c28543a3a4163636f756e7449642c20543a3a4163636f756e744964293e08b02044697361626c6520616e6420616464206f7261636c657320666f722074686520676976656e20666565642e80204c696d6974656420746f20746865206f776e6572206f66206120666565642e507570646174655f6675747572655f726f756e6473141c666565645f696424543a3a4665656449641c7061796d656e743042616c616e63654f663c543e5c7375626d697373696f6e5f636f756e745f626f756e647328287533322c207533322934726573746172745f64656c617928543a3a526f756e6449641c74696d656f757438543a3a426c6f636b4e756d62657208cc205570646174652074686520636f6e66696775726174696f6e20666f7220667574757265206f7261636c6520726f756e64732e80204c696d6974656420746f20746865206f776e6572206f66206120666565642e147072756e650c1c666565645f696424543a3a4665656449643866697273745f746f5f7072756e6528543a3a526f756e644964286b6565705f726f756e6428543a3a526f756e64496408c8205072756e6520746865207374617465206f662061206665656420746f207265647563652073746f72616765206c6f61642e80204c696d6974656420746f20746865206f776e6572206f66206120666565642e347365745f7265717565737465720c1c666565645f696424543a3a4665656449642472657175657374657230543a3a4163636f756e7449641464656c617928543a3a526f756e64496408ac2053657420726571756573746572207065726d697373696f6e7320666f722060726571756573746572602e6c204c696d6974656420746f207468652066656564206f776e65722e4072656d6f76655f726571756573746572081c666565645f696424543a3a4665656449642472657175657374657230543a3a4163636f756e74496408b82052656d6f766520726571756573746572207065726d697373696f6e7320666f722060726571756573746572602e6c204c696d6974656420746f207468652066656564206f776e65722e44726571756573745f6e65775f726f756e64041c666565645f696424543a3a46656564496408a4205265717565737420746865207374617274206f662061206e6577206f7261636c6520726f756e642ec4204c696d6974656420746f206163636f756e74732077697468202272657175657374657222207065726d697373696f6e2e4077697468647261775f7061796d656e740c186f7261636c6530543a3a4163636f756e74496424726563697069656e7430543a3a4163636f756e74496418616d6f756e743042616c616e63654f663c543e08f82057697468647261772060616d6f756e7460207061796d656e74206f662074686520676976656e206f7261636c6520746f2060726563697069656e74602e74204c696d6974656420746f20746865206f7261636c652061646d696e2e387472616e736665725f61646d696e08186f7261636c6530543a3a4163636f756e744964246e65775f61646d696e30543a3a4163636f756e74496408c420496e69746961746520616e2061646d696e207472616e7366657220666f722074686520676976656e206f7261636c652e94204c696d6974656420746f20746865206f7261636c652061646d696e206163636f756e742e306163636570745f61646d696e04186f7261636c6530543a3a4163636f756e74496408c420436f6d706c65746520616e2061646d696e207472616e7366657220666f722074686520676976656e206f7261636c652eb4204c696d6974656420746f207468652070656e64696e67206f7261636c652061646d696e206163636f756e742e3877697468647261775f66756e64730824726563697069656e7430543a3a4163636f756e74496418616d6f756e743042616c616e63654f663c543e08a02057697468647261772060616d6f756e74602066756e647320746f2060726563697069656e74602e74204c696d6974656420746f207468652070616c6c65742061646d696e2e2c7265647563655f646562740418616d6f756e743042616c616e63654f663c543e0cf4205265647563652074686520616d6f756e74206f66206465627420696e207468652070616c6c6574206279206d6f76696e672066756e64732066726f6df82074686520667265652062616c616e636520746f2074686520726573657276656420736f206f7261636c65732063616e206265207061796564206f75742e74204c696d6974656420746f207468652070616c6c65742061646d696e2e547472616e736665725f70616c6c65745f61646d696e04406e65775f70616c6c65745f61646d696e30543a3a4163636f756e74496408ac20496e69746961746520616e2061646d696e207472616e7366657220666f72207468652070616c6c65742e94204c696d6974656420746f207468652070616c6c65742061646d696e206163636f756e742e4c6163636570745f70616c6c65745f61646d696e0008ac20436f6d706c65746520616e2061646d696e207472616e7366657220666f72207468652070616c6c65742eb4204c696d6974656420746f207468652070656e64696e672070616c6c65742061646d696e206163636f756e742e407365745f666565645f63726561746f72042c6e65775f63726561746f7230543a3a4163636f756e74496408c020416c6c6f772074686520676976656e206163636f756e7420746f20637265617465206f7261636c652066656564732e94204c696d6974656420746f207468652070616c6c65742061646d696e206163636f756e742e4c72656d6f76655f666565645f63726561746f72041c63726561746f7230543a3a4163636f756e74496408cc20446973616c6c6f772074686520676976656e206163636f756e7420746f20637265617465206f7261636c652066656564732e94204c696d6974656420746f207468652070616c6c65742061646d696e206163636f756e742e013c2c46656564437265617465640818466565644964244163636f756e74496404d02041206e6577206f7261636c6520666565642077617320637265617465642e205c5b666565645f69642c2063726561746f725c5d204e6577526f756e6410184665656449641c526f756e644964244163636f756e7449642c426c6f636b4e756d6265720405012041206e657720726f756e642077617320737461727465642e205c5b6e65775f726f756e645f69642c20696e69746961746f722c20737461727465645f61745c5d485375626d697373696f6e526563656976656410184665656449641c526f756e6449641456616c7565244163636f756e7449640415012041207375626d697373696f6e20776173207265636f726465642e205c5b666565645f69642c20726f756e645f69642c207375626d697373696f6e2c206f7261636c655c5d34416e737765725570646174656410184665656449641c526f756e6449641456616c75652c426c6f636b4e756d6265720469012054686520616e7377657220666f722074686520726f756e642077617320757064617465642e205c5b666565645f69642c20726f756e645f69642c206e65775f616e737765722c20757064617465645f61745f626c6f636b5c5d4c526f756e6444657461696c735570646174656414184665656449641c42616c616e6365405375626d697373696f6e426f756e64731c526f756e6449642c426c6f636b4e756d6265720475012054686520726f756e642064657461696c73207765726520757064617465642e205c5b7061796d656e742c207375626d697373696f6e5f636f756e745f626f756e64732c20726573746172745f64656c61792c2074696d656f75745c5d684f7261636c6541646d696e5570646174655265717565737465640c244163636f756e744964244163636f756e744964244163636f756e74496404550120416e2061646d696e206368616e6765207761732072657175657374656420666f722074686520676976656e206f7261636c652e205c5b6f7261636c652c2061646d696e2c2070656e64696e675f61646d696e5c5d484f7261636c6541646d696e5570646174656408244163636f756e744964244163636f756e74496404d4205468652061646d696e206368616e6765207761732065786563757465642e205c5b6f7261636c652c206e65775f61646d696e5c5d604f7261636c655065726d697373696f6e73557064617465640c18466565644964244163636f756e74496410626f6f6c04990120546865207375626d697373696f6e207065726d697373696f6e7320666f722074686520676976656e206665656420616e64206f72616c63652068617665206265656e20757064617465642e205c5b666565642c206f7261636c652c20656e61626c65645c5d5c5265717565737465725065726d697373696f6e735365741018466565644964244163636f756e74496410626f6f6c1c526f756e6449640499012054686520726571756573746572207065726d697373696f6e732068617665206265656e20757064617465642028736574206f722072656d6f766564292e205c5b666565642c207265717565737465722c20617574686f72697a65642c2064656c6179735c5d504f776e65725570646174655265717565737465640c18466565644964244163636f756e744964244163636f756e74496404450120416e206f776e6572206368616e6765207761732072657175657374656420666f722074686520676976656e20666565642e205c5b666565642c206f6c645f6f776e65722c206e65775f6f776e65725c5d304f776e6572557064617465640818466565644964244163636f756e74496404cc20546865206f776e6572206368616e6765207761732065786563757465642e205c5b666565642c206e65775f6f776e65725c5d6850616c6c657441646d696e55706461746552657175657374656408244163636f756e744964244163636f756e74496404310120412070616c6c65742061646d696e206368616e676520776173207265717565737465642e205c5b6f6c645f70616c6c65745f61646d696e2c206e65775f70616c6c65745f61646d696e5c5d4850616c6c657441646d696e5570646174656404244163636f756e74496404d0205468652070616c6c65742061646d696e206368616e6765207761732065786563757465642e205c5b6e65775f61646d696e5c5d2c4665656443726561746f7204244163636f756e74496404e020546865206163636f756e7420697320616c6c6f77656420746f206372656174652066656564732e205c5b6e65775f63726561746f725c5d484665656443726561746f7252656d6f76656404244163636f756e74496404250120546865206163636f756e74206973206e6f206c6f6e67657220616c6c6f77656420746f206372656174652066656564732e205c5b70726576696f75736c795f63726561746f725c5d042c46756e644163636f756e7430543a3a4163636f756e744964806d6f646c6c696e6b66656564000000000000000000000000000000000000000004150120546865206163636f756e74207573656420746f20706179206f7261636c657320616e64206d616e616765207468652066756e6473206f6620746869732070616c6c65742e00083854656d706c6174654d6f64756c65013854656d706c6174654d6f64756c650424536f6d657468696e6700000c753332040000010c28726561645f76616c7565000030646f5f736f6d657468696e670424736f6d657468696e670c753332085d0120416e206578616d706c6520646973706174636861626c6520746861742074616b657320612073696e676c65732076616c7565206173206120706172616d657465722c20777269746573207468652076616c756520746f51012073746f7261676520616e6420656d69747320616e206576656e742e20546869732066756e6374696f6e206d75737420626520646973706174636865642062792061207369676e65642065787472696e7369632e2c63617573655f6572726f720004dc20416e206578616d706c6520646973706174636861626c652074686174206d6179207468726f77206120637573746f6d206572726f722e01083c536f6d657468696e6753746f726564080c753332244163636f756e744964085d01204576656e7420646f63756d656e746174696f6e2073686f756c6420656e64207769746820616e20617272617920746861742070726f7669646573206465736372697074697665206e616d657320666f72206576656e747420706172616d65746572732e205b736f6d657468696e672c2077686f5d1c4e657744617461041456616c756500000c244e6f6e6556616c7565048c204572726f72206e616d65732073686f756c642062652064657363726970746976652e3c53746f726167654f766572666c6f7704fc204572726f72732073686f756c6420686176652068656c7066756c20646f63756d656e746174696f6e206173736f6369617465642077697468207468656d2e2c466565644d697373696e670009041c40436865636b5370656356657273696f6e38436865636b547856657273696f6e30436865636b47656e6573697338436865636b4d6f7274616c69747928436865636b4e6f6e63652c436865636b576569676874604368617267655472616e73616374696f6e5061796d656e74"
	substrateAliceAccountIdHex = "d43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d"
)

func addressFromAccountId(s []byte) (*types.Address, error) {
	decoder := gob.NewDecoder(bytes.NewReader(s))
	var addr types.Address
	return &addr, decoder.Decode(&addr)
}

type mockSubscriber struct {
	responses map[string]chan []byte
}

func newMockSubscriber() (*mockSubscriber, *map[string]chan []byte) {
	m := mockSubscriber{}
	return &m, &m.responses
}

func (m *mockSubscriber) Subscribe(method string, _ json.RawMessage, responses chan<- []byte) (func(), error) {
	ch, ok := m.responses[method]
	if !ok {
		return nil, errors.New("doesnt have a response channel")
	}

	stop := make(chan struct{})

	go func() {
		for {
			select {
			case <-stop:
				return
			case resp, ok := <-ch:
				if !ok {
					return
				}
				responses <- resp
			}
		}
	}()

	return func() {
		close(stop)
	}, nil
}

func (m *mockSubscriber) Request(method string, _ json.RawMessage) ([]byte, error) {
	ch, ok := m.responses[method]
	if !ok {
		return nil, errors.New("doesnt have a response channel")
	}

	return <-ch, nil
}

func (m mockSubscriber) Stop() {
	return
}

func makeMockSubstrateManager(t testing.TB) (substrateManager, *map[string]chan []byte) {
	var metadata types.Metadata
	err := types.DecodeFromHexString(substrateTestMetadataHex, &metadata)
	require.NoError(t, err)

	sub, chs := newMockSubscriber()

	addr, err := types.NewAddressFromHexAccountID(substrateAliceAccountIdHex)
	require.NoError(t, err)

	return substrateManager{
		meta:         &metadata,
		endpointName: "test",
		feedId:       0,
		accountId:    addr.AsAccountID,
		subscriber:   sub,
	}, chs
}

func MustDecodeHex(s string) []byte {
	data, _ := hex.DecodeString(s)
	return data
}

func Test_getChanges(t *testing.T) {
	type args struct {
		key  types.StorageKey
		data []byte
	}
	tests := []struct {
		name    string
		args    args
		want    []types.KeyValueOption
		wantErr bool
	}{
		{
			name: "gets a value",
			args: args{
				key:  types.NewStorageKey(MustDecodeHex("1ae70894dea2956c24d9c19ac4d15d334f9828de31b1944b243d7cfa8f863607")),
				data: []byte(`{"result":{"block":"0x0400bf57e54d9043203d8b8766dca498e7a86b48b048fe65c7e6a8750532e5ce","changes":[["0x1ae70894dea2956c24d9c19ac4d15d334f9828de31b1944b243d7cfa8f863607","0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d"]]},"subscription":"Vhdet0j80btCi4nz"}`),
			},
			want: []types.KeyValueOption{
				{
					StorageKey:     types.NewStorageKey(MustDecodeHex("1ae70894dea2956c24d9c19ac4d15d334f9828de31b1944b243d7cfa8f863607")),
					HasStorageData: true,
					StorageData:    types.NewStorageDataRaw(MustDecodeHex("d43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d")),
				},
			},
			wantErr: false,
		},
		{
			name: "gets a result with no change",
			args: args{
				key:  types.NewStorageKey(MustDecodeHex("1ae70894dea2956c24d9c19ac4d15d33c112c4b12e2be4c71e6501a2d50d7e40")),
				data: []byte(`{"result":{"block":"0x6374c6e27838a2edff58550a82d43b7e0f209b30eabc455acbf1284bc4ec129f","changes":[["0x1ae70894dea2956c24d9c19ac4d15d33c112c4b12e2be4c71e6501a2d50d7e40",null]]},"subscription":"T2EcUQJkmaR3YGL0"}`),
			},
			want: []types.KeyValueOption{
				{
					StorageKey:     types.NewStorageKey(MustDecodeHex("1ae70894dea2956c24d9c19ac4d15d33c112c4b12e2be4c71e6501a2d50d7e40")),
					HasStorageData: true,
					StorageData:    types.NewStorageDataRaw([]byte{}),
				},
			},
			wantErr: false,
		},
		{
			name: "only gets the correct storage key",
			args: args{
				key:  types.NewStorageKey(MustDecodeHex("1ae70894dea2956c24d9c19ac4d15d334f9828de31b1944b243d7cfa8f863607")),
				data: []byte(`{"result":{"block":"0x0400bf57e54d9043203d8b8766dca498e7a86b48b048fe65c7e6a8750532e5ce","changes":[["0x1ae70894dea2956c24d9c19ac4d15d33c112c4b12e2be4c71e6501a2d50d7e40","0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27e"],["0x1ae70894dea2956c24d9c19ac4d15d334f9828de31b1944b243d7cfa8f863607","0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d"]]},"subscription":"Vhdet0j80btCi4nz"}`),
			},
			want: []types.KeyValueOption{
				{
					StorageKey:     types.NewStorageKey(MustDecodeHex("1ae70894dea2956c24d9c19ac4d15d334f9828de31b1944b243d7cfa8f863607")),
					HasStorageData: true,
					StorageData:    types.NewStorageDataRaw(MustDecodeHex("d43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d")),
				},
			},
			wantErr: false,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			got, err := getChanges(tt.args.key, tt.args.data)
			if (err != nil) != tt.wantErr {
				t.Errorf("getChanges() error = %v, wantErr %v", err, tt.wantErr)
				return
			}
			if !reflect.DeepEqual(got, tt.want) {
				t.Errorf("getChanges() got = %v, want %v", got, tt.want)
			}
		})
	}
}

func Test_parseChange(t *testing.T) {
	var accountId types.AccountID
	var feedId FeedId
	var feedConfig FeedConfigOf

	type args struct {
		key  types.StorageKey
		data []byte
		t    interface{}
	}
	tests := []struct {
		name    string
		args    args
		wantErr bool
	}{
		{
			name: "parses account id",
			args: args{
				key:  types.NewStorageKey(MustDecodeHex("1ae70894dea2956c24d9c19ac4d15d334f9828de31b1944b243d7cfa8f863607")),
				data: []byte(`{"result":{"block":"0x0400bf57e54d9043203d8b8766dca498e7a86b48b048fe65c7e6a8750532e5ce","changes":[["0x1ae70894dea2956c24d9c19ac4d15d334f9828de31b1944b243d7cfa8f863607","0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d"]]},"subscription":"Vhdet0j80btCi4nz"}`),
				t:    &accountId,
			},
			wantErr: false,
		},
		{
			name: "parses feed id",
			args: args{
				key:  types.NewStorageKey(MustDecodeHex("1ae70894dea2956c24d9c19ac4d15d33c112c4b12e2be4c71e6501a2d50d7e40")),
				data: []byte(`{"result":{"block":"0x0109640cb073a8c704938224424bf127b851ddaefe9a47b9acd2557c30eaec14","changes":[["0x1ae70894dea2956c24d9c19ac4d15d33c112c4b12e2be4c71e6501a2d50d7e40","0x01000000"]]},"subscription":"GK6frSf4qIDtxmPl"}`),
				t:    &feedId,
			},
			wantErr: false,
		},
		{
			name: "parses feed config",
			args: args{
				key:  types.NewStorageKey(MustDecodeHex("1ae70894dea2956c24d9c19ac4d15d33407d94c38db8ad2e4aa005c8942ac2c5b4def25cfda6ef3a00000000")),
				data: []byte(`{"result":{"block":"0xd7dc4513267131485cb3476cd48e15be86e7683458a24401c232290428fdbc7c","changes":[["0x1ae70894dea2956c24d9c19ac4d15d33407d94c38db8ad2e4aa005c8942ac2c5b4def25cfda6ef3a00000000","0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d00000000000000000000000000000000009f860100000000000000000000000000010000000100000000e8764817000000000000000000000001000000020801230000000000000000000000000001000000"]]},"subscription":"gVK1dqmAOifBAKrw"}`),
				t:    &feedConfig,
			},
			wantErr: false,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			if err := parseChange(tt.args.key, tt.args.data, tt.args.t); (err != nil) != tt.wantErr {
				t.Errorf("parseChange() error = %v, wantErr %v", err, tt.wantErr)
			}
			fmt.Println(feedConfig)
		})
	}
}
